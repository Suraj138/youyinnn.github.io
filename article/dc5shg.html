<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="baidu-site-verification" content="l09YSIpJQW" />
    <meta name="referrer" content="origin">
    <title>blog | youyinnn</title>
    <script src="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@latest/myjs/loadscripts.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@latest/myjs/jump-1.4.js"></script>
    <link rel="bookmark" href="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@latest/img/favicon.ico" />
    <link rel="icon" href="/img/favicon.ico" type="image/ico"/>
    <link rel="stylesheet" href="/mycss/style.css">

    <script src="/myjs/scriptlist.js"></script>
</head>

<body>

    <ol id="topbar" class="breadcrumb unselectable new_font">
        <p style="color:rgb(214, 214, 214); padding-right: 1rem;">
            <button id="egg" class="egg">🚀</button>&nbsp;&nbsp;&nbsp;&nbsp;&gt;</p>
        <li class="breadcrumb-item">
            <spen id="homebut" href="javaScript:void(0)" class="ah">-home</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="articlesbut" href="javaScript:void(0)" class="ah">-articles</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="scriptbut" href="javaScript:void(0)" class="ah">-scripts</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="todobut" href="javaScript:void(0)" class="ah">-todos</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="resumebut" href="javaScript:void(0)" class="ah">-resume</spen>
        </li>
        <li class="breadcrumb-item dropdown">
            <spen href="javaScript:void(0)" class="ah" role="button" id="friendlinkedbut" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">-friends</spen>
            <div id="fldd" class="dropdown-menu" aria-labelledby="friendlinkedbut" style="border-radius: initial;"></div>
        </li>

        <div id="hb" data-toggle="tooltip" data-placement="bottom" title="show/hide TopBar">

        </div>
    </ol>

    <div id="homepage" class="unselectable new_font myhide">
        <div id="homepage-center">
            <div id="slogan">
                <i id="wolf-logo" style="font-style: normal;" class="mr-4">🌑</i><span id="slogan-text"></span>
            </div>
            <div id="homepage-btn">
                <div id="showmore"> &nbsp;&nbsp;&nbsp;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp; About Me & This Blog</div>
                <div id="showhacknical"> &nbsp;&nbsp;&nbsp;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp; My Github Analysis</div>
                <div id="toarticles"> &nbsp;&nbsp;&nbsp;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp; My Tech Articles</div>
            </div>
        </div>
        <div id="ifwrapper" class="hacknical_hide">
            <iframe id="hacknical_github_analysis" frameborder="0"></iframe>
        </div>
    </div>

    <div id="articles_side_panel" class="unselectable myhide new_font">
        <div id="cates_tree_head">Article Categories</div>
        <div id="cates_tree_body"></div>
        <div id="blog_statistic_head">Blog Statistics</div>
        <table id="blog_statistic_body" class="myhide">
            <tbody>
                <tr>
                    <td style="text-align:right">Online:</td>
                    <td style="text-align:left" id="stat_running"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Article:</td>
                    <td style="text-align:left" id="stat_article_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Chars:</td>
                    <td style="text-align:left" id="stat_typein"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Categories:</td>
                    <td style="text-align:left" id="stat_cate_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Tags:</td>
                    <td style="text-align:left" id="stat_tag_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Last update:</td>
                    <td style="text-align:left" id="stat_last_update"></td>
                </tr>
            </tbody>
        </table>
    </div>
    <div id="docpanel" class="myhide new_font">
        <div id="articlesearch" class="input-group">
            <input id="articlesearchtext" type="text" class="form-control" autocomplete="off" placeholder="search with keywords (algolia)">
            <div id="searchprocessbar">
                <div id="spb-out" class="spb-outter-animate"></div>
                <div id="spb-in" class="spb-inner-animate"></div>
            </div>
            <div class="input-group-append">
                <button id="cleanbut" class="btn btn-light" type="button" title="clear search">cls</button>
                <button id="categories" class="btn btn-light" type="button">cates</button>
                <button id="tags" class="btn btn-light" type="button" title="all tags">tags</button>
                <button id="articlesearchbut" class="btn btn-light" type="button" title="search">sch</button>
            </div>
        </div>
        <div id="searchrscount" class="unselectable"></div>
        <div class="tgs myhide" id="all_cates">
            <span style="font-size: 1rem; font-weight: bold ; padding: 6px;">All categories:</span>
            <br>
        </div>
        <div class="tgs myhide" id="all_tags">
            <span style="font-size: 1rem; font-weight: bold ; padding: 6px;">All tags:</span>
            <br>
        </div>
    </div>

    <div id="sidetoccontainer" class="tochide unselectable new_font">
        <div id="block">
            <div id="percent" data-toggle="tooltip" data-placement="bottom" title="return to the top">0%</div>
        </div>
        <div id="sidetoc" class="unselectable markdown-body editormd-preview-container markdown-toc"></div>
    </div>
    <div id="md" class="myhide markdown-body editormd-html-preview">
        
          <h3 id="7fa34206">概述</h3><p>本篇主要介绍InnoDB中的锁，以及它与隔离级别之间的关系。从锁的算法、锁的等级、锁解决的问题来为MySQL的InnoDB锁做一个概述</p>
<p>我们能够轻易地想到，对数据库的数据进行操作的时候，为了保证数据一致性和持久性，我们会对这些操作上锁，但数据库中并不只有这些情况会上锁，其他地方也会有锁，比如缓冲池中页的增删改查的时候</p>
<p>而不同引擎、不同数据库对锁的实现和支持都是不一样的，比如MyISAM只支持表锁，在并发情况下的随机写操作性能就会差点，除非是插入到数据页的底部，那稍微并发性能高点</p>
<p>而InnoDB的并发效率会好很多，它提供了非锁定读，行锁等锁粒度细的支持</p>

          <h3 id="6d33473b">InnoDB中的锁</h3>
          <h4 id="4705e2da">表锁与行锁</h4><p>InnoDB支持行级的读写锁：</p>
<ul>
<li>共享锁（S Lock）：允许事务读取一行数据；</li>
<li>排他锁（X Lock）：允许事务删除或更新一行数据；</li>
</ul>
<p>而InnoDB是支持<strong>多粒度锁定</strong>的，即这种机制允许事务同时持有行锁和表锁，为了实现这个机制，引擎提供了一种叫意向锁的锁，我们把库、表、页、行想象成一棵自顶向下的树，我们若要对某行上<strong>写锁X Lock</strong>，那我们就得先对其所属的库、表、页处也上<strong>写意向锁 IX Lock</strong>，最后再对该行上<strong>X Lock</strong></p>
<p>在有意向锁的行为下，加入一个事务要对行上<strong>写锁X Lock</strong>，但这时候该行所属的表上有<strong>读意向锁IS Lock</strong>，那么事务需要等待表上的读意向锁释放之后，才能再加上读意向锁</p>
<p>于是我们发现，意向锁就是InnoDB的<strong>表级锁</strong>，也是读写锁的形式：</p>
<ul>
<li>意向共享锁（IS Lock）：事务要获取一张表中某几行的共享锁；</li>
<li>意向排他锁（IX Lock）：事务要获取一张表中某几行的排他锁；</li>
</ul>
<p>行锁表锁之间的兼容性：</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">IS</th>
<th align="center">IX</th>
<th align="center">S</th>
<th align="center">X</th>
</tr>
</thead>
<tbody><tr>
<td align="center">IS</td>
<td align="center">✔️</td>
<td align="center">✔️</td>
<td align="center">✔️</td>
<td align="center">✖️</td>
</tr>
<tr>
<td align="center">IX</td>
<td align="center">✔️</td>
<td align="center">✔️</td>
<td align="center">​✖️​</td>
<td align="center">​✖️​</td>
</tr>
<tr>
<td align="center">S</td>
<td align="center">✔️</td>
<td align="center">​✖️​</td>
<td align="center">✔️</td>
<td align="center">​✖️​</td>
</tr>
<tr>
<td align="center">X</td>
<td align="center">​✖️​</td>
<td align="center">​✖️​</td>
<td align="center">​✖️​</td>
<td align="center">​✖️​</td>
</tr>
</tbody></table>

          <h4 id="d0072b83">一致性非锁定读</h4><p>在理论模型中，读锁会在写锁被持有的时候阻塞而写锁会在读锁被持有的时候阻塞，但是为了提高并发效率，InnoDB还是实现了<strong>MVCC</strong>的机制来规避读写互斥带来的的并发性能下将：<strong>通过恒读取数据之前的版本来避免阻塞</strong></p>
<p>在上篇<a href="./tx6g0p.html">《MySQL InnoDB事务概述》</a>里说到，事务过程中的undo会提供MVCC支持，而且在默认的隔离级别下也会有这个特性，在读取数据的时候会读取快照；而上篇里没提到的是，不同隔离级别的快照读取的方式不同：</p>
<ul>
<li>READ COMMITTED：总是读取最新的一份快照；</li>
<li>REPEATEABLE READ：总是读取事务开始时的快照版本；</li>
</ul>

          <h4 id="3b3ea3dd">一致性锁定读</h4><p>虽然有了MVCC让我们在读取上不会阻塞，但我们有时候还是想强制使用理论模型的标准来强制读写互斥，这时候可以显式地对读取操作加锁而保证逻辑一致性</p>
<p>InnoDB支持以下两种加锁：</p>
<ul>
<li><p><code>select ... for update</code></p>
<p>对读取的行记录加一个X锁，其他事务不能对该行上任何锁；</p>
</li>
<li><p><code>select ... lock in share mode</code></p>
<p>对读取的行记录加一个S锁，而其他读事务可以执行，其他写事务阻塞；</p>
</li>
</ul>

          <h3 id="7a6f9b01">InnoDB行锁算法</h3><p>InnoDB有3种行锁算法：</p>
<ul>
<li>Record Lock：锁单行；</li>
<li>Gap Lock：间隙锁，锁一个范围，但是不包括记录本身；</li>
<li>Next-Key Lock：Gap Lock + Record Lock，锁记录本身的同时还锁一个范围；而且这个锁是根据索引记录来执行的，如果表没有设置任何的索引，那么引擎会使用隐式的主键来进行锁定；</li>
</ul>
<p>在隔离级别为<strong>READ COMMITTED</strong>下，仅采用<strong><em>Record Lock</em></strong>算法；</p>
<p>而在隔离级别为<strong>REPEATABLE READ</strong>下，InnoDB对于行的查询都使用的是<strong><em>Next-Key Lock</em></strong>算法，假如一个索引有10，11，13，20四个值，那么Next-Key Lock可能会锁住：<code>(-∞, 10]</code>，<code>(10, 11]</code>，<code>(11, 13]</code>，<code>(13, 20]</code>，<code>(20, +∞)</code>等区间；这种技术被称为<strong>Next-Key Locking</strong>，</p>
<p>对应的，还会有<strong>Previous-Key Locking</strong>，其对应会锁住的区间为<code>(-∞, 10)</code>，<code>[10, 11)</code>，<code>[11, 13)</code>，<code>[13, 20)</code>，<code>[20, +∞)</code></p>

          <h4 id="8621d40b">锁降级</h4><p>虽然对于所有查询，使用的都是范围锁，但当查询索引含有<strong>唯一索引</strong>的时候，范围锁会<strong>降级</strong>为Record Lock，只锁住单行，比如有数据：</p>
<pre><code class="language-sql">create table t ( a int primary key );
insert into t select 1;
insert into t select 2;
insert into t select 5;</code></pre>
<p>再执行：</p>
<table>
<thead>
<tr>
<th align="center">时间</th>
<th align="center">会话A</th>
<th align="center">会话B</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">begin;</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">select * from t where a = 5 for update;</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">3</td>
<td align="center"></td>
<td align="center">begin;</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center"></td>
<td align="center">insert into t select 4;</td>
</tr>
<tr>
<td align="center">5</td>
<td align="center"></td>
<td align="center">commit; #直接成功而不需要等待</td>
</tr>
<tr>
<td align="center">6</td>
<td align="center">commit;</td>
<td align="center"></td>
</tr>
</tbody></table>
<p>我们看到，虽然再会话A我们请求了一个X锁，但是索引是等等值的5，于是它锁<strong>降级</strong>，它只会锁住这一行记录，所以会话B的插入等值4这一操作不会被阻塞；</p>
<p>但是，如果是非唯一索引，比如辅助索引，那么就不会发生降级，比如有</p>
<pre><code class="language-sql">create table t ( a int , b int, primary key(a), key(b) );
insert into t select 1,1;
insert into t select 3,1;
insert into t select 5,3;
insert into t select 7,6;
insert into t select 10,8;</code></pre>
<p>对于查询：</p>
<pre><code class="language-sql">select * from t where b = 3 for update;</code></pre>
<p>上述要使用列b进行索引，但因为有两个索引，索引需要分别进行锁定；</p>
<ul>
<li>对于聚集索引，仅对于列<code>a=5</code>的索引加上Record Lock，锁降级；</li>
<li>对于辅助索引，应用的是Next-Key Lock，锁住键值区间<code>(1, 3)</code>和<code>(3, 6)</code>；</li>
</ul>

          <h4 id="9376e653">锁升级</h4><p>锁升级是指将<strong>当前锁的粒度降低</strong>，比如可以把一个表的1000个行锁升级为一个页锁，或者页锁升级为表锁，这在各个数据库或者引擎里都有实现</p>
<p>但是<strong>InnoDB并不实现这一特性</strong>，因为它不是通过记录本身去产生行锁的，而是采用<strong>位图</strong>的方式，对<strong>每个事务</strong>访问的<strong>每个页</strong>进行锁管理，因此：一个事务不管是锁住页中的<strong>一个记录</strong>还是<strong>多个记录</strong>，其开销通常都是<strong>一样的</strong>；</p>

          <h3 id="9537cc3b">锁相关问题与解决</h3>
          <h4 id="540ea1be">Phantom Problem（幻读问题）</h4><p>在默认隔离级别下，InnoDB使用Next-Key Locking机制来避免幻读，之前提到过很多幻读这一词，幻读的真正定义如下：</p>
<blockquote>
<p><strong>Phantom Problem是指在同一事务下，连续执行两次同样的SQL可能会导致不同的结果，第二次的SQL可能会返回之前不存在的行。</strong></p>
</blockquote>

          <h4 id="a86b41e1">Dirty Read（脏读问题）</h4><p>脏数据是指事物对缓冲页的数据进行修改，但是还没有被提交，所以我们并不希望脏数据能够被读取到</p>
<p>脏读一般已经很少发生了，除非你非要把隔离级别设置为<strong>READ UNCOMMITTED</strong></p>

          <h4 id="9d357f66">Nonrepeatable Read（不可重复读）</h4><p>指一个事务内多次读取同一数据集合，在事务还没有结束的时候，另一个事务对该数据集合进行了更新，因此在第一个事务执行过程中的两次读取之间造成数据差异</p>
<p>该问题和脏读的区别是，脏读是读到了未提交的数据，不可重复度是读到了已提交的数据，都违反了数据库事务的<strong>一致性</strong>要求</p>
<p>某种程度上说，<strong>不可重复读也是幻读问题</strong>，这在MySQL官方文档中明确了这一点，它也能够通过Next-Key Lock算法来避免这一问题</p>

          <h4 id="2e1ee179">Dead Lock（死锁）</h4><p>事务在等待锁的时候会造成阻塞，如果出现了循环阻塞，那么就会造成死锁，而死锁有两种解决方式</p>
<p>一般的做法是超时，但是对于长事务的作业如果应用超时后再回滚，那么会浪费掉很多性能以及时间，甚至是undo log；</p>
<p>所以当前数据库包括InnoDB引擎采用的普遍的做法是<strong><em>wait-for graph</em></strong>，这是一种主动的死锁检测机制：<strong>通过将事务构造成节点，然后多个事务根据等待关系链成链表，然后检测是否有回路的这么一种方式来检测是否出现死锁；</strong></p>
<p>如果出现回路，<strong>通常来说</strong>引擎会回滚undo量小的事务，也会有回滚undo量大的事务的情况；</p>

    </div>
    <div id="scriptsearcher" class="myhide input-group new_font">
        <input id="searchtext" type="text" class="form-control" placeholder="keywords" autocomplete="off">
        <div class="input-group-append">
            <button id="searchbut" class="btn btn-dark" type="button">Search</button>
        </div>
    </div>

    <div id="bbt" class="myhide new_font">
        <a id="toc" style="display: none;" class="myhide" href="javascript:void(0);" data-toggle="tooltip" data-placement="left" title="show/hide Toc">Toc</a>
        <a id="gohub" href="#" target="_blank" data-toggle="tooltip" data-placement="bottom" title="view this at github">unuse</a>
    </div>

    <div id="share_png_panel" class="myhide">
        <div id="share_curtain"></div>
        <div id="png_box"></div>
        <button id="share_png_paned_close" class="btn btn-dark">Close</button>
    </div>

</body>

</html>