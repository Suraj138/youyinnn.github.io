## :star: MySQL

### MySQL用户管理

``` sql
// 查看所有用户
use mysql;
select * from user;

// 查看用户权限
how grants;
show grants for root;

// 授予用户权限
grant select on base.table to hi;
grant all on base.* to 'hi'@'localhost';
// 移除用户权限
revoke select on base.table from hi;
// 刷新权限
flush privileges;

// 创建用户
create user hi identified by 'passowrd';
// 删除用户
drop user hi;

// 改密码
set password for hi = Password('new password');
// 改自己密码
set password = Password('new password');
```

https://www.cnblogs.com/gavin110-lgy/p/5773981.html
https://www.cnblogs.com/clsn/p/8047028.html



### MySQL自己更新自己


https://www.cnblogs.com/jeffen/p/7016547.html

mysql不允许在同一次执行中自己更新自己 所以要套一次层中间查询 欺骗mysql以为不是同一张表



### MySQL系统体系架构

![](https://image.youyinnn.top/20200611194657.png)

根据图里我们可以发现，MySQL系统最核心的“存储引擎”是以插件的形式为系统提供服务的，这种架构提供了与存储引擎实现无关的一系列标准服务支持，让引擎的实现能够解放出来。

**需要注意的是，存储引擎是基于表的，而不是数据库**

### MySQL各引擎介绍

#### InnoDB

MySQL5.5.8以后的默认引擎，支持事物、行锁设计、外键、全文索引、非锁定读（默认读操作不会产生锁）

使用多版本并发控制（MVCC）来支持高并发性，并实现了4中标准的隔离级别，能避免幻读；还提供了许多其他的特性来支持高性能高并发；每张表按照主键顺序进行存放；

#### MyISAM

不支持事物、表锁设计，支持全文索引；

缓冲池不缓存数据，只缓存索引；

#### NDB

集群存储引擎，特点是数据都放在内存中，而非索引数据存在磁盘上，因此性能很快，但是连接操作时性能很差，因为该操作是在数据库完成的，而不是又引擎完成的；

#### Memory

数据都在内存中，数据库如果重启或者崩溃就会丢失所有数据，适合用于存储临时数据；默认使用哈希索引，而不是B+树索引；

但是只支持表锁，所以并发性能差，不支持全部数据类型；

#### Archive

只支持Insert和Select操作，特点是会对数据进行压缩，压缩比高，适合存储归档数据、日志信息等；

虽然支持行锁，但是不支持事物；



### MySQL日志文件有哪些

#### 错误日志

错误日志对MySQL的启动、运行、关闭过程进行记录，在MySQL用户操作出现错误的时候，错误信息会被记录在这个日志里

而系统也会在运行时发出一些警告，提示用户需要优化系统

通过以下命令查看日志的位置：

``` sql
show variables like 'log_error';
```

#### 慢查询日志

在MySQL启动的时候可以设置一个阈值，MySQL系统就会将运行时间超过这个阈值的SQL语句记录到慢查询日志中，如果出现这种SQL，你可能需要考虑是否能够优化或者拆分这个SQL业务相关的业务

#### 查询日志

记录了所有用户对MySQL数据库的请求信息

#### 二进制日志

记录了所有MySQL数据库执行的更改操作，不包括select和show这类操作，二进制日志的作用主要有：

- 恢复数据；
- 复制数据；
- 审计（判断是否有对数据库的注入攻击）；

#### InnoDB存储引擎文件

- 表空间文件：InnoDB将存储的数据按照表空间进行存放；
- 重做日志文件：记录了对于InnoDB引擎的事务日志；不同的操作有不同个重做日志格式；



### InnoDB逻辑存储结构

![](https://image.youyinnn.top/20200612124701.png)

所有数据都被存放在一个空间中，称为**表空间**，而表空间又由**段（segment）、区（extent）、页（page）**组成

#### 表空间

表空间是InnoDB存储引擎的最高层，所有数据都存放在表空间，默认情况下只有一个共享表空间，如果用参数配置了`innodb_file_per_table`，那么每张表内的数据可以单独放在一个表空间内

每张表的单独表空间只存放数据、索引、插入缓冲Bitmap页，而其他的数据如回滚信息、插入缓冲索引页、系统事务信息、二次写缓冲等还是存放在原来的共享表空间里

#### 段

表空间由段组成，常见的段有数据段、索引段、回滚段

由于InnoDB的存储引擎表是由索引组织的，所以数据即索引，索引即数据，这点在B+树上的体现为：数据段为B+树的子叶节点，索引段为B+树的非索引节点

#### 区

区由连续的页组成，每个区的大小都是1MB，且为了保证页的连续性，引擎每次都会申请4个以上的区，默认情况下，一页有16KB，于是一个区有64张连续的页；

#### 页

页的默认大小为16KB，但也可以通过配置来调整

常见的页类型有：

- 数据页（B-tree Node）；
- undo页；
- 系统页；
- 事物数据页；
- 插入缓冲位图页；
- 插入缓冲空闲列表页；
- 未压缩的二进制大对象页；
- 已压缩的二进制大对象页；

#### 行

InnoDB引擎是面向行的，每页最多允许存放7992行记录；



### InnoDB约束类型&概念

关系型数据库系统和文件系统的一个区别是，关系型数据库本身能保证数据的完整性，不需要程序控制

所有的关系型数据库都提供了约束机制，利用这个机制区保证数据完整性，一般来说，数据完整性包括：

- 保证表中有一个主键，在InnoDB中可以使用Primary Key或者Unique Key约束来保证；
- 触发器；
- 域完整性，保证每列的值满足特定条件；

在InnoDB中，提供的约束有：

- Primary Key；
- Unique Key；
- Foreign Key；
- Default；
- Not Null；
- ENUM & SET约束，但是约束力很小，建议使用触发器；

我们需要在创建表的时候就就列字段设定约束，也可以创建完之后用alter table来修改约束：

``` sql
create table test (
	id int,
    name varchar(20),
    id_card char(18),
    primiary key (id),
    unique key (name)
);
```

#### 约束和索引的区别

约束是逻辑上的概念，用来保证数据完整性，而索引是数据结构，不仅有逻辑概念，还代表着物理存储方式



### 触发器概念

MySQL5.1之后，触发器的实现已经稳定，我们可以使用其来对数据进行约束，**触发器的作用是在执行INSERT、UPDATE、DELETE操作的之前和之后自动调用SQL命令或者存储过程**

最多可以为一个表建立6个触发器：INSERT、UPDATE、DELETE的Before和After各建立一个，目前只支持按照**每行记录**进行触发

通过触发器，用户可以实现MySQL本身不支持的**特性**，比如Check约束（检查某个值的合法性）、物化视图、高级复制、审计等等；



### 视图概念

视图的主要用途就算被用作为抽象装置，一些程序如果不需要关心表的结构，只需要按照视图定义来**取数据**或者**更新数据**，因此视图在一定程度上起到了安全层的作用；

虽然视图只是虚拟表，没有物理文件，但是我们依然可以通过视图来**更新数据**