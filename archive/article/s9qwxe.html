<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="baidu-site-verification" content="l09YSIpJQW" />
    <meta name="referrer" content="origin">
    <title>blog | youyinnn</title>
    <script src="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@latest/myjs/loadscripts.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@latest/myjs/jump-1.4.js"></script>
    <link rel="bookmark" href="https://cdn.jsdelivr.net/gh/youyinnn/youyinnn.github.io@latest/img/favicon.ico" />
    <link rel="icon" href="/img/favicon.ico" type="image/ico"/>
    <link rel="stylesheet" href="/mycss/style.css">

    <script src="/resources/resources.js"></script>
    <script src="/myjs/scriptlist.js"></script>
</head>

<body>

    <ol id="topbar" class="breadcrumb unselectable new_font">
        <p style="color:rgb(214, 214, 214); padding-right: 1rem;">
            <button id="egg" class="egg">🚀</button>&nbsp;&nbsp;&nbsp;&nbsp;&gt;</p>
        <li class="breadcrumb-item">
            <spen id="homebut" href="javaScript:void(0)" class="ah">-home</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="articlesbut" href="javaScript:void(0)" class="ah">-articles</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="scriptbut" href="javaScript:void(0)" class="ah">-scripts</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="todobut" href="javaScript:void(0)" class="ah">-todos</spen>
        </li>
        <li class="breadcrumb-item">
            <spen id="resumebut" href="javaScript:void(0)" class="ah">-resume</spen>
        </li>
        <li class="breadcrumb-item dropdown">
            <spen href="javaScript:void(0)" class="ah" role="button" id="friendlinkedbut" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">-friends</spen>
            <div id="fldd" class="dropdown-menu" aria-labelledby="friendlinkedbut" style="border-radius: initial;"></div>
        </li>

        <div id="hb" data-toggle="tooltip" data-placement="bottom" title="show/hide TopBar">

        </div>
    </ol>

    <div id="homepage" class="unselectable new_font myhide">
        <div id="homepage-center">
            <div id="slogan">
                <i id="wolf-logo" style="font-style: normal;" class="mr-4">🌑</i><span id="slogan-text"></span>
            </div>
            <div id="homepage-btn">
                <div id="showmore"> &nbsp;&nbsp;&nbsp;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp; About Me & This Blog</div>
                <div id="showhacknical"> &nbsp;&nbsp;&nbsp;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp; My Github Analysis</div>
                <div id="toarticles"> &nbsp;&nbsp;&nbsp;&nbsp;&gt;&nbsp;&nbsp;&nbsp;&nbsp; My Tech Articles</div>
            </div>
        </div>
        <div id="ifwrapper" class="hacknical_hide">
            <iframe id="hacknical_github_analysis" frameborder="0"></iframe>
        </div>
    </div>

    <div id="articles_side_panel" class="unselectable myhide new_font">
        <div id="cates_tree_head">Article Categories</div>
        <div id="cates_tree_body"></div>
        <div id="blog_statistic_head">Blog Statistics</div>
        <table id="blog_statistic_body" class="myhide">
            <tbody>
                <tr>
                    <td style="text-align:right">Online:</td>
                    <td style="text-align:left" id="stat_running"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Article:</td>
                    <td style="text-align:left" id="stat_article_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Chars:</td>
                    <td style="text-align:left" id="stat_typein"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Categories:</td>
                    <td style="text-align:left" id="stat_cate_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Tags:</td>
                    <td style="text-align:left" id="stat_tag_count"></td>
                </tr>
                <tr>
                    <td style="text-align:right">Last update:</td>
                    <td style="text-align:left" id="stat_last_update"></td>
                </tr>
            </tbody>
        </table>
    </div>
    <div id="docpanel" class="myhide new_font">
        <div id="articlesearch" class="input-group">
            <input id="articlesearchtext" type="text" class="form-control" autocomplete="off" placeholder="search with keywords (algolia)">
            <div id="searchprocessbar">
                <div id="spb-out" class="spb-outter-animate"></div>
                <div id="spb-in" class="spb-inner-animate"></div>
            </div>
            <div class="input-group-append">
                <button id="cleanbut" class="btn btn-light" type="button" title="clear search">cls</button>
                <button id="categories" class="btn btn-light" type="button">cates</button>
                <button id="tags" class="btn btn-light" type="button" title="all tags">tags</button>
                <button id="articlesearchbut" class="btn btn-light" type="button" title="search">sch</button>
            </div>
        </div>
        <div id="searchrscount" class="unselectable"></div>
        <div class="tgs myhide" id="all_cates">
            <span style="font-size: 1rem; font-weight: bold ; padding: 6px;">All categories:</span>
            <br>
        </div>
        <div class="tgs myhide" id="all_tags">
            <span style="font-size: 1rem; font-weight: bold ; padding: 6px;">All tags:</span>
            <br>
        </div>
    </div>

    <div id="sidetoccontainer" class="tochide unselectable new_font">
        <div id="block">
            <div id="percent" data-toggle="tooltip" data-placement="bottom" title="return to the top">0%</div>
        </div>
        <div id="sidetoc" class="unselectable markdown-body editormd-preview-container markdown-toc"></div>
    </div>
    <div id="md" class="myhide markdown-body editormd-html-preview">
        
          <h3 id="6fe6d02f">介绍</h3><p>本篇主要介绍了MySQL系统的核心引擎，本系列所有的内容是基于姜承尧老师所著<em>《MySQL技术内幕：InnoDB存储引擎》</em>再加上整理的网络笔记、MySQL5.7的<a href="https://dev.mysql.com/doc/refman/5.7/en/">官方文档</a>和自己的一些理解</p>

          <h3 id="314ac60a">InnoDB</h3><p>MySQL5.5.8以后的默认引擎，支持事物、行锁设计、外键、全文索引、非锁定读（默认读操作不会产生锁）；</p>
<p>使用多版本并发控制（MVCC）来支持高并发性，并实现了4中标准的隔离级别，能避免幻读；还提供了许多其他的特性来支持高性能高并发；</p>

          <h4 id="46f207ed">体系架构</h4><p>
        <div class="_showpic_f596600e showpicbtn">Loading images >></div>
        <img href=https://image.youyinnn.top/20200611211157.png class="_pic_f596600e hidepic" picId="f596600e"></img>
        <script>
            {
                let imgselff596600es = document.getElementsByClassName('_pic_f596600e')
                let showpicbtnf596600es = document.getElementsByClassName('_showpic_f596600e')
                let isInViewPortOfTwof596600e = function () {
                    const viewPortHeight = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight 
                    const top = imgselff596600es[0].getBoundingClientRect() && imgselff596600es[0].getBoundingClientRect().top
                    if (top  <= viewPortHeight + 300) {
                        for (el of imgselff596600es) {
                            el.src = el.getAttribute('href')
                            el.classList.add('showpic')
                            window.removeEventListener('scroll', isInViewPortOfTwof596600e)
                            isInViewPortOfTwof596600e = null
                        }
                        for (el of showpicbtnf596600es) {
                            el.style.display = 'none'
                        }
                    }
                }
                window.addEventListener('scroll', isInViewPortOfTwof596600e)
            }
        </script>
    </p>
<p>引擎的内存中主要包含以下工作区域：</p>
<ol>
<li>线程维护区域/线程所需内部数据结构区域</li>
<li>数据缓存，数据修改之后并不是马上进入磁盘文件，而是先缓存在这里；</li>
<li>重做日志缓冲；</li>
</ol>

          <h4 id="62ac9c96">后台线程的分类</h4><ol>
<li><strong>Master Thread</strong>：核心线程，主要负责将缓冲池中的数据异步地刷新到磁盘，保证数据一致性；</li>
<li><strong>IO Thread</strong>：引擎使用了大量的AIO技术来处理写IO请求，以提高数据库的性能，该线程的工作是处理这些IO的回调；而在Windows系统中，IO线程的数量可以调整；</li>
<li><strong>Purge Thread</strong>：事物被提交后，其所使用的undolog可能不再被需要，该线程是负责回收这些被分配的undo页；该线程的线程数也支持配置，提高性能；</li>
<li><strong>Page Cleaner Thread</strong>：主要完成脏页的刷新操作，提高性能；</li>
</ol>

          <h4 id="eb60b32f">内存/内存对象</h4>
          <h4 id="72a6197b">缓冲池</h4><p>InnoDB是基于磁盘文件存储的引擎，并将数据按页分配和管理。而由于CPU和磁盘的IO差距，想要提高性能，肯定是要利用系统内存区弥补IO差距的，所以我们可以简单地将缓冲池理解为磁盘数据文件的内存映射</p>

          <h5 id="8cfe5dc3">基本逻辑和内容</h5><p><strong>读操作</strong>：系统启动的时候，会缓存（FIX）部分页到缓冲池里，在读页的时候，首先去缓冲池里找，如果找到了就直接读取，否则就从磁盘上读</p>
<p><strong>写操作</strong>：首先修改缓冲池中的页，然后再以一定频率刷新到次磁盘上，而且不是一有页更新就刷，而是根据一种叫<strong>Checkpoint</strong>的机制来刷</p>
<p>缓冲池的内存大小也直接影响了数据库的性能，我们也可以再配置中调节它的大小，也能够调节缓冲池的实例个数，多缓冲池实例的好处是每个页会更散列地分配到不同实例当中，好处是减少内部资源竞争</p>
<p>缓冲池的内存数据对象如下：</p>
<p>
        <div class="_showpic_5c8a4cfe showpicbtn">Loading images >></div>
        <img href=https://image.youyinnn.top/20200611215932.png class="_pic_5c8a4cfe hidepic" picId="5c8a4cfe"></img>
        <script>
            {
                let imgself5c8a4cfes = document.getElementsByClassName('_pic_5c8a4cfe')
                let showpicbtn5c8a4cfes = document.getElementsByClassName('_showpic_5c8a4cfe')
                let isInViewPortOfTwo5c8a4cfe = function () {
                    const viewPortHeight = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight 
                    const top = imgself5c8a4cfes[0].getBoundingClientRect() && imgself5c8a4cfes[0].getBoundingClientRect().top
                    if (top  <= viewPortHeight + 300) {
                        for (el of imgself5c8a4cfes) {
                            el.src = el.getAttribute('href')
                            el.classList.add('showpic')
                            window.removeEventListener('scroll', isInViewPortOfTwo5c8a4cfe)
                            isInViewPortOfTwo5c8a4cfe = null
                        }
                        for (el of showpicbtn5c8a4cfes) {
                            el.style.display = 'none'
                        }
                    }
                }
                window.addEventListener('scroll', isInViewPortOfTwo5c8a4cfe)
            }
        </script>
    </p>

          <h5 id="5566a55f">缓冲算法</h5><p>对于缓冲池的管理，引擎使用了基本的三种算法来完成：<strong>LRU List、Free List、Flush List</strong></p>
<p>假设我们知道基本的LRU缓存算法，但再InnoDB中的LRU算法又不太一样，它提供了一个<strong><em>midpoint</em></strong>来处理使用频率更新时，节点的放置策略：在新读取到页的时候，虽然是最新访问的，但是并不是放到队列的头部，而是放在大概中间的位置，默认是列表长度的5/8处，这个值也是可以进行配置的</p>
<p>而我们把这个点之前的页称为new列表，表示是使用频繁的热点数据，后面的称为old列表</p>
<p>InnoDB之所以对算法进行改进的原因是：某些SQL操作可以能会把相当一部分的页甚至是所有页都刷出去，如果热点数据放在头部，那么它有可能最早被刷出，而下一次需要的时候，又从磁盘读取，非常影响性能</p>
<p><strong>Free列表是干嘛的呢？</strong></p>
<p>在数据库刚启动的时候，LRU列表是空的，没有任何的页，因为这时候页都在Free列表中。当需要从缓冲池中分页的时候，首先从Free列表中查找是否有可用的空闲页，有就直接将该页从Free列表移动到LRU列表</p>
<p><strong>Flush列表和脏页</strong></p>
<p>在LRU列表中的页被修改之后，该页被称为脏页，这时候该页的数据和磁盘上对应的映射数据不一致，于是引擎通过Checkpoint机制将脏页刷回磁盘，我们把脏页都放在Flush列表中</p>
<p><em>注意：脏页即存在LRU列表中，页存在Flush列表中，两者逻辑上分工不同</em></p>

          <h5 id="817cec08">重做日志缓冲</h5><p>在一个事物的过程中，引擎会先把重做日志放到缓冲区，然后再按照频率刷新到重做日志文件。在这样的场景下，重做日志缓存一般不会占用太多内存，保证每秒的事物量在这个范围内就好，默认的8M，也是能够配置的</p>
<blockquote>
<p>重做日志刷新的时机：</p>
<ol>
<li>Master Thread每一秒都刷一次；</li>
<li>每个事物提交的时候也会刷；</li>
<li>重做日志空间剩余空间小于1/2的时候，也会刷；</li>
</ol>
</blockquote>

          <h5 id="f3ceaea4">额外的内存</h5><p>剩下还有一些额外内存，用于分配数据库所需的对象、数据结构等，用于记录锁信息和LRU以及等待的信息</p>

          <h4 id="5e7eb397">Checkpoint机制</h4><p> 当出现脏页的时候，需要把数据刷回磁盘，但不能每出现一次脏页就刷回，这样会增加IO的压力，从而性能会很差；同时，如果在刷页的时候系统挂了，那么数据就难以恢复；大部分数据库系统采用了Write Ahead Log的策略，即先写重做日志，再修改页，在出意外的时候，可用日志恢复；</p>
<p>而Checkpoint技术的出现主要是为了解决：</p>
<ol>
<li><p>缩短数据恢复的时间；</p>
<blockquote>
<p>当系统挂掉的时候，数据库不需要套重做所有的日志，checkpoint之前的页已经刷回磁盘；只需要恢复checkpoint后面的页就行；</p>
</blockquote>
</li>
<li><p>缓冲池不够用的时候，将脏页刷到磁盘；</p>
<blockquote>
<p>缓冲池不够用的时候，LRU算法会溢出最近少使用的页，如果这个页是脏页，那么需要强制执行checkpoint，将脏页刷回磁盘</p>
</blockquote>
</li>
<li><p>重做日志<strong>不可用</strong>的时候，刷新脏页；</p>
<blockquote>
<p>在重做日志不够用的时候，强制产生checkpoint，将缓冲池的页至少刷新到当前重做日志的位置；</p>
</blockquote>
</li>
</ol>
<p>Checkpont分为2种：</p>
<ol>
<li>Sharp Checkpoint：数据库即将关闭的时候将所有的脏页刷回磁盘；</li>
<li>Fuzzy Checkpoint：运行时的Checkpoint，每次只刷新部分脏页，保证数据库可用性；</li>
</ol>

          <h4 id="d181215f">Main Thread</h4><p>Main Thread具有最高的线程优先级，其内部由多个循环组成：主循环（loop）、后台循环（backgroud loop）、暂停循环（suspend loop）。主线程会根据数据库的状态在不同下循环之间进行切换</p>

          <h5 id="26394c8">Loop</h5><p>主循环的工作有2部分：</p>
<ol>
<li>每秒一次：<ul>
<li>（总是）日志缓存刷到磁盘，即使事物还没提交；</li>
<li>（可能）合并插入缓冲，是否发生看IO的次数，次数小就可用执行合并；</li>
<li>（可能）最多刷100个脏页到磁盘，是否发生看脏页比例，超过某个阈值就刷；</li>
<li>（可能）如果当前用户没有活动，切换到后台循环；</li>
</ul>
</li>
<li>每10秒一次：<ul>
<li>（可能）刷100个脏页；</li>
<li>（总是）合并若干个插入缓冲；</li>
<li>（总是）刷日志到磁盘；</li>
<li>（总是）删除无用的Undo页；</li>
<li>（总是）刷100个脏页或者10个脏页到磁盘；</li>
</ul>
</li>
</ol>
<p>在InnoDB版本迭代之后，每次可以刷不只100页脏页，可以自己调节</p>

          <h5 id="be0fc286">Background Loop</h5><p>如果当前用户没有活动，或者数据库要关闭了，那么就会切换到这个循环，它的工作有：</p>
<ol>
<li>（总是）删除无用的Undo页；</li>
<li>（总是）合并20个插入缓冲；</li>
<li>（总是）跳回主循环；</li>
<li>（可能）刷100页直到符合条件（在flush loop还在主线程的时候）</li>
</ol>

    </div>
    <div id="scriptsearcher" class="myhide input-group new_font">
        <input id="searchtext" type="text" class="form-control" placeholder="keywords" autocomplete="off">
        <div class="input-group-append">
            <button id="searchbut" class="btn btn-dark" type="button">Search</button>
        </div>
    </div>

    <div id="bbt" class="myhide new_font">
        <a id="toc" style="display: none;" class="myhide" href="javascript:void(0);" data-toggle="tooltip" data-placement="left" title="show/hide Toc">Toc</a>
        <a id="gohub" href="#" target="_blank" data-toggle="tooltip" data-placement="bottom" title="view this at github">unuse</a>
    </div>

    <div id="share_png_panel" class="myhide">
        <div id="share_curtain"></div>
        <div id="png_box"></div>
        <button id="share_png_paned_close" class="btn btn-dark">Close</button>
    </div>

</body>

</html>